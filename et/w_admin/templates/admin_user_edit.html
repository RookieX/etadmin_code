{% extends base.html %}

{% block pos %}
编辑后台用户
{% end %}

{% block main %}
<form id="admin_user_form" method="post">
    <div class="formbody">
        <div class="formtitle"><span>后台用户编辑</span></div>

        <ul class="forminfo">
            <li>
                <label>用户名</label>
                <input name="user_name" type="text" class="dfinput" value="{{ model.user_name }}" {% if bag.is_update %}disabled{% end %}/>
            </li>
            <li>
                <label>显示名</label>
                <input name="display_name" type="text" class="dfinput" value="{{ model.display_name }}"/>
            </li>
            <li>
                <label>用户类型</label>
                <div class="vocation">
                    <select name="user_type">
                        <option value="">
                            请选择
                        </option>
                        {% for user_type_val,user_type_name in bag.user_types %}
                        <option value="{{ user_type_val }}"
                                {% if user_type_val == model.user_type %}selected{% end %}>{{ user_type_name }}</option>
                        {% end %}
                    </select>
                </div>
            </li>
            <li>
                <label>职位</label>
                <div class="vocation">
                    <select id="position_id" name="position_id">
                        <option value="">
                            请选择
                        </option>
                        {% for pos in bag.positions %}
                        <option dept_id="{{ pos.department.id }}" value="{{ pos.id }}"
                                {% if pos.id == model.position.id %}selected{% end %}>{{ pos.name }}</option>
                        {% end %}
                    </select>
                </div>
            </li>
            <li>
                <label>部门</label>
                <div class="vocation">
                    <select id="department_id" name="department_id">
                        <option value="">
                        </option>
                        {% for dept in bag.departments %}
                        <option value="{{ dept.id }}"
                                {% if dept.id == model.department.id %}selected{% end %}>{{ dept.name }}</option>
                        {% end %}
                    </select>
                </div>
            </li>
            <li>
                <label>&nbsp;</label>
                <input type="submit" class="btn" value="确认保存"/>
            </li>
        </ul>
    </div>
</form>
</div>
<input id="is_update" type="hidden" value="{{ bag.is_update }}">
{% end %}

{% block footer %}
<script type="text/javascript">
    $(function () {
        $('#position_id').change(function () {
            var dept_id = $('#position_id option:selected').attr('dept_id');
            $('#department_id').val('1');
            $('#department_id').uedSelect('setOption');
        });

        //表单验证
        $('#admin_user_form').validate({
            errorElement: 'p',
            errorClass: 'valid-error',
            rules: {
                user_name: {
                    required: true
                },
                display_name: {
                    required: true
                },
                user_type: {
                    required: true
                },
                position_id: {
                    required: true
                }
            },
            messages: {
                user_name: {
                    required: '请填写用户名'
                },
                display_name: {
                    required: '请填写显示名'
                },
                user_type: {
                    required: '请选择用户类型'
                },
                position_id: {
                    required: '请选择用户职位'
                }
            },
            submitHandler: function (form) {
                $(form).ajaxSubmit({
                    dataType: 'JSON',
                    data: {
                        is_update: $('#is_update').val()
                    },
                    success: function (resp) {
                        if (resp.status === 0) {
                            alert('保存成功');
                        } else {
                            alert(resp.msg);
                        }
                    },
                    error: function () {
                        alert('提交失败');
                    }
                });
            }
        });
    });
</script>
{% end %}